<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proyecci√≥n de Itinerario de Viaje</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #888; padding: 6px; text-align: center; }
    th { background: #eee; }
    input[type="number"], input[type="text"], select {
      width: 100%; box-sizing: border-box;
    }
    button { margin: 5px; }
    .total { font-weight: bold; background: #e4f7e4; }
    .section-title { font-size: 18px; margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 5px; }
  </style>
</head>
<body>

<h1>Proyecci√≥n de Itinerario de Viaje</h1>

<div class="section-title">1. Informaci√≥n General</div>
<p>
  Nombre: <input type="text" id="nombre" style="width: 300px;">
  Proyecto: <input type="text" id="proyecto" style="width: 300px;">
</p>

<div class="section-title">2. Transporte</div>
<table id="transporte">
  <thead>
    <tr>
      <th>Origen</th><th>Destino</th><th>Medio</th><th>Valor Unitario</th><th># Trayectos</th><th>Subtotal</th><th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="addRow('transporte')">‚ûï Agregar fila</button>

<div class="section-title">3. Alojamiento</div>
<table id="alojamiento">
  <thead>
    <tr>
      <th>Ciudad</th><th>Noches</th><th>Valor por noche</th><th>Subtotal</th><th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="addRow('alojamiento')">‚ûï Agregar fila</button>

<div class="section-title">4. Vi√°ticos</div>
<table id="viaticos">
  <thead>
    <tr>
      <th>Ciudad</th><th>D√≠as</th><th>Vi√°ticos por d√≠a</th><th>Transporte local</th><th>Subtotal</th><th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="addRow('viaticos')">‚ûï Agregar fila</button>

<div class="section-title">5. Totales</div>
<table>
  <tr><th>Transporte</th><td id="totalTransporte" class="total">$0</td></tr>
  <tr><th>Alojamiento</th><td id="totalAlojamiento" class="total">$0</td></tr>
  <tr><th>Vi√°ticos</th><td id="totalViaticos" class="total">$0</td></tr>
  <tr><th>Total General</th><td id="totalGeneral" class="total">$0</td></tr>
</table>

<button onclick="exportCSV()">üìÅ Exportar CSV</button>

<script>
  function formatCOP(val) {
    return "$" + (val || 0).toLocaleString("es-CO");
  }

  function calcAll() {
    calc('transporte', 3, 4, 5, 'totalTransporte');
    calc('alojamiento', 1, 2, 3, 'totalAlojamiento');
    calc('viaticos', 1, 2, 4, 'totalViaticos', 3);
    const t = getValue('totalTransporte'), a = getValue('totalAlojamiento'), v = getValue('totalViaticos');
    document.getElementById('totalGeneral').innerText = formatCOP(t + a + v);
  }

  function calc(tableId, valIdx, qtyIdx, subtIdx, totalId, extraIdx = null) {
    let rows = document.querySelectorAll(`#${tableId} tbody tr`);
    let total = 0;
    rows.forEach(row => {
      let val = +row.children[valIdx].children[0].value || 0;
      let qty = +row.children[qtyIdx].children[0].value || 0;
      let extra = extraIdx !== null ? +row.children[extraIdx].children[0].value || 0 : 0;
      let subt = (val * qty) + extra;
      row.children[subtIdx].innerText = formatCOP(subt);
      total += subt;
    });
    document.getElementById(totalId).innerText = formatCOP(total);
  }

  function getValue(id) {
    return +(document.getElementById(id).innerText.replace(/[^\d]/g, '')) || 0;
  }

  function addRow(tableId) {
    let table = document.querySelector(`#${tableId} tbody`);
    let row = document.createElement('tr');

    if (tableId === 'transporte') {
      row.innerHTML = `
        <td><input type="text"></td>
        <td><input type="text"></td>
        <td><select><option>A√©reo</option><option>Terrestre</option><option>Fluvial</option><option>Otro</option></select></td>
        <td><input type="number" value="0" oninput="calcAll()"></td>
        <td><input type="number" value="1" oninput="calcAll()"></td>
        <td>$0</td>
        <td><button onclick="this.parentNode.parentNode.remove(); calcAll()">üóë</button></td>
      `;
    } else if (tableId === 'alojamiento') {
      row.innerHTML = `
        <td><input type="text"></td>
        <td><input type="number" value="0" oninput="calcAll()"></td>
        <td><input type="number" value="0" oninput="calcAll()"></td>
        <td>$0</td>
        <td><button onclick="this.parentNode.parentNode.remove(); calcAll()">üóë</button></td>
      `;
    } else if (tableId === 'viaticos') {
      row.innerHTML = `
        <td><input type="text"></td>
        <td><input type="number" value="0" oninput="calcAll()"></td>
        <td><input type="number" value="0" oninput="calcAll()"></td>
        <td><input type="number" value="0" oninput="calcAll()"></td>
        <td>$0</td>
        <td><button onclick="this.parentNode.parentNode.remove(); calcAll()">üóë</button></td>
      `;
    }
    table.appendChild(row);
    calcAll();
  }

  function exportCSV() {
    let csv = [];
    csv.push(`Nombre:,${document.getElementById("nombre").value}`);
    csv.push(`Proyecto:,${document.getElementById("proyecto").value}`);
    csv.push("\nSECCI√ìN,ORIGEN/CIUDAD,DESTINO/NOCHES,D√çAS/MEDIO,VALOR UNIT,TRAYECTOS/NOCHES,OTROS,Subtotal");

    const tables = ['transporte', 'alojamiento', 'viaticos'];
    tables.forEach(id => {
      document.querySelectorAll(`#${id} tbody tr`).forEach(row => {
        let data = Array.from(row.querySelectorAll("input, select")).map(el => el.value || "");
        let subtotal = row.children[row.children.length - 2].innerText;
        csv.push([id.toUpperCase()].concat(data).concat(subtotal).join(","));
      });
    });

    csv.push("\n,TOTALES,,,," +
      document.getElementById("totalTransporte").innerText + "," +
      document.getElementById("totalAlojamiento").innerText + "," +
      document.getElementById("totalViaticos").innerText + "," +
      document.getElementById("totalGeneral").innerText);

    let blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
    let link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", "itinerario_viaje.csv");
    link.click();
  }

  // Inicializa con una fila en cada tabla
  addRow('transporte');
  addRow('alojamiento');
  addRow('viaticos');
</script>

</body>
</html>
